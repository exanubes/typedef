name: Release

on:
  push:
    tags:
      - "v*" # Trigger on version tags like v1.0.0
  workflow_dispatch: # Allow manual trigger

jobs:
  prepare-version:
    name: Prepare Version Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit-sha: ${{ steps.version.outputs.commit-sha }}
      build-time: ${{ steps.version.outputs.build-time }}

    steps:
      - name: Extract version information
        id: version
        run: |
          # Extract version from tag (strip 'v' prefix)
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          else
            VERSION="dev"
          fi

          # Get commit SHA (short form)
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHA="${COMMIT_SHA:0:7}"

          # Generate build timestamp (ISO 8601 / RFC3339)
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit-sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "build-time=${BUILD_TIME}" >> $GITHUB_OUTPUT

          echo "Building version: ${VERSION}"
          echo "Commit SHA: ${COMMIT_SHA}"
          echo "Build time: ${BUILD_TIME}"

  test:
    uses: ./.github/workflows/tests.yml
    with:
      go-version: "1.24.4"
      node-version: "22"

  build:
    needs: [test, prepare-version]
    uses: ./.github/workflows/build.yml
    with:
      go-version: "1.24.4"
      build-all-platforms: true # Build all platforms for releases
      version: ${{ needs.prepare-version.outputs.version }}
      commit-sha: ${{ needs.prepare-version.outputs.commit-sha }}
      build-time: ${{ needs.prepare-version.outputs.build-time }}

  build-web:
    needs: build
    uses: ./.github/workflows/build-web.yml
    with:
      node-version: "22"
      pnpm-version: "10.11.0"
      upload-artifacts: true

  publish-nvim:
    needs: [build-web, prepare-version]
    uses: ./.github/workflows/build-nvim.yml
    with:
      version: ${{ needs.prepare-version.outputs.version }}
      commit-sha: ${{ needs.prepare-version.outputs.commit-sha }}
      build-time: ${{ needs.prepare-version.outputs.build-time }}
    secrets: inherit

  publish-pages:
    needs: build-web
    uses: ./.github/workflows/publish-pages.yml
    permissions:
      contents: write

  create-release:
    needs: publish-pages
    uses: ./.github/workflows/create-release-notes.yml
    permissions:
      contents: write
