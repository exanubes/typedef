name: Build Binaries

on:
  workflow_call:
    inputs:
      go-version:
        description: "Go version for builds"
        required: false
        type: string
        default: "1.24.4"
      build-all-platforms:
        description: "Build all platforms (true) or verify only (false)"
        required: false
        type: boolean
        default: false
      build-targets:
        description: "Comma-separated list of build targets (cli, rpc, wasm). Empty = build all"
        required: false
        type: string
        default: ""
      version:
        description: "Version string (e.g., 0.0.5)"
        required: false
        type: string
        default: "dev"
      commit-sha:
        description: "Git commit SHA"
        required: false
        type: string
        default: "unknown"
      build-time:
        description: "Build timestamp (RFC3339 format)"
        required: false
        type: string
        default: "unknown"
  workflow_dispatch:
    inputs:
      go-version:
        description: "Go version for builds"
        required: false
        type: string
        default: "1.24.4"
      build-all-platforms:
        description: "Build all platforms (true) or verify only (false)"
        required: false
        type: boolean
        default: true
      build-targets:
        description: "Comma-separated list of build targets (cli, rpc, wasm). Empty = build all"
        required: false
        type: string
        default: ""
      version:
        description: "Version string (e.g., 0.0.5)"
        required: false
        type: string
        default: "dev"
      commit-sha:
        description: "Git commit SHA"
        required: false
        type: string
        default: ""
      build-time:
        description: "Build timestamp (RFC3339 format)"
        required: false
        type: string
        default: ""

jobs:
  prepare:
    name: Prepare build metadata
    runs-on: ubuntu-latest
    outputs:
      commit-sha: ${{ steps.metadata.outputs.commit-sha }}
      build-time: ${{ steps.metadata.outputs.build-time }}
    steps:
      - name: Generate metadata
        id: metadata
        run: |
          if [ -z "${{ inputs.commit-sha }}" ]; then
            echo "commit-sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "commit-sha=${{ inputs.commit-sha }}" >> $GITHUB_OUTPUT
          fi

          if [ -z "${{ inputs.build-time }}" ]; then
            BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "build-time=$BUILD_TIME" >> $GITHUB_OUTPUT
          else
            echo "build-time=${{ inputs.build-time }}" >> $GITHUB_OUTPUT
          fi

  build-linux:
    name: Build CLI (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: prepare
    if: ${{ inputs.build-targets == '' || contains(inputs.build-targets, 'cli') }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - run: go mod download

      - name: Build Linux binaries
        if: ${{ inputs.build-all-platforms }}
        run: |
          make build-linux \
            VERSION="${{ inputs.version }}" \
            COMMIT_SHA="${{ needs.prepare.outputs.commit-sha }}" \
            BUILD_TIME="${{ needs.prepare.outputs.build-time }}"

      - name: Verify build (Linux only)
        if: ${{ !inputs.build-all-platforms }}
        run: make build-cli

      - name: Upload Linux artifacts
        if: ${{ inputs.build-all-platforms }}
        uses: actions/upload-artifact@v4
        with:
          name: cli-linux
          path: dist/cli/linux/*
          retention-days: 1

  build-macos:
    name: Build CLI (macOS)
    runs-on: macos-latest
    timeout-minutes: 5
    needs: prepare
    if: ${{ inputs.build-targets == '' || contains(inputs.build-targets, 'cli') }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/Library/Caches/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - run: go mod download

      - name: Build macOS binaries
        if: ${{ inputs.build-all-platforms }}
        run: |
          make build-macos \
            VERSION="${{ inputs.version }}" \
            COMMIT_SHA="${{ needs.prepare.outputs.commit-sha }}" \
            BUILD_TIME="${{ needs.prepare.outputs.build-time }}"

      - name: Verify build (macOS only)
        if: ${{ !inputs.build-all-platforms }}
        run: make build-cli

      - name: Upload macOS artifacts
        if: ${{ inputs.build-all-platforms }}
        uses: actions/upload-artifact@v4
        with:
          name: cli-macos
          path: dist/cli/darwin/*
          retention-days: 1

  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: prepare
    if: ${{ inputs.build-targets == '' || contains(inputs.build-targets, 'wasm') }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - run: go mod download

      - name: Build WASM
        run: |
          make build-wasm \
            VERSION="${{ inputs.version }}" \
            COMMIT_SHA="${{ needs.prepare.outputs.commit-sha }}" \
            BUILD_TIME="${{ needs.prepare.outputs.build-time }}"

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm
          path: dist/wasm/main.wasm
          retention-days: 1

  build-rpc-linux:
    name: Build RPC (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: prepare
    if: ${{ inputs.build-targets == '' || contains(inputs.build-targets, 'rpc') }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - run: go mod download

      - name: Build RPC Linux binaries
        if: ${{ inputs.build-all-platforms }}
        run: |
          make build-rpc-linux \
            VERSION="${{ inputs.version }}" \
            COMMIT_SHA="${{ needs.prepare.outputs.commit-sha }}" \
            BUILD_TIME="${{ needs.prepare.outputs.build-time }}"

      - name: Upload RPC Linux artifacts
        if: ${{ inputs.build-all-platforms }}
        uses: actions/upload-artifact@v4
        with:
          name: rpc-linux
          path: dist/rpc/linux/*
          retention-days: 1

  build-rpc-macos:
    name: Build RPC (macOS)
    runs-on: macos-latest
    timeout-minutes: 5
    needs: prepare
    if: ${{ inputs.build-targets == '' || contains(inputs.build-targets, 'rpc') }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/Library/Caches/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - run: go mod download

      - name: Build RPC macOS binaries
        if: ${{ inputs.build-all-platforms }}
        run: |
          make build-rpc-macos \
            VERSION="${{ inputs.version }}" \
            COMMIT_SHA="${{ needs.prepare.outputs.commit-sha }}" \
            BUILD_TIME="${{ needs.prepare.outputs.build-time }}"

      - name: Upload RPC macOS artifacts
        if: ${{ inputs.build-all-platforms }}
        uses: actions/upload-artifact@v4
        with:
          name: rpc-macos
          path: dist/rpc/darwin/*
          retention-days: 1

  package:
    name: Package binaries and generate checksums
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [build-linux, build-macos, build-rpc-linux, build-rpc-macos]
    if: ${{ inputs.build-all-platforms }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download CLI Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: cli-linux
          path: ./artifacts/linux

      - name: Download CLI macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: cli-macos
          path: ./artifacts/darwin

      - name: Download RPC Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpc-linux
          path: ./artifacts/linux

      - name: Download RPC macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpc-macos
          path: ./artifacts/darwin

      - name: Make packaging script executable
        run: chmod +x scripts/package-binary.sh

      - name: Package binaries
        run: |
          mkdir -p release

          # Package CLI binaries
          ./scripts/package-binary.sh ./artifacts/linux/amd64/typedef-cli linux amd64 ./release
          ./scripts/package-binary.sh ./artifacts/linux/arm64/typedef-cli linux arm64 ./release
          ./scripts/package-binary.sh ./artifacts/darwin/amd64/typedef-cli darwin amd64 ./release
          ./scripts/package-binary.sh ./artifacts/darwin/arm64/typedef-cli darwin arm64 ./release

          # Package RPC binaries
          ./scripts/package-binary.sh ./artifacts/linux/amd64/typedef-rpc linux amd64 ./release
          ./scripts/package-binary.sh ./artifacts/linux/arm64/typedef-rpc linux arm64 ./release
          ./scripts/package-binary.sh ./artifacts/darwin/amd64/typedef-rpc darwin amd64 ./release
          ./scripts/package-binary.sh ./artifacts/darwin/arm64/typedef-rpc darwin arm64 ./release

      - name: Generate checksums
        run: |
          cd release
          sha256sum typedef-*.tar.gz > checksums.txt
          cat checksums.txt

      - name: Upload packaged CLI binaries
        uses: actions/upload-artifact@v4
        with:
          name: cli-packages
          path: release/typedef-cli-*.tar.gz
          retention-days: 1

      - name: Upload packaged RPC binaries
        uses: actions/upload-artifact@v4
        with:
          name: rpc-packages
          path: release/typedef-rpc-*.tar.gz
          retention-days: 1

      - name: Upload checksums artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: release/checksums.txt
          retention-days: 1
