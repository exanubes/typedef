name: Build Binaries

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version for builds'
        required: false
        type: string
        default: '1.24.4'
      build-all-platforms:
        description: 'Build all platforms (true) or verify only (false)'
        required: false
        type: boolean
        default: false
      version:
        description: 'Version string (e.g., 0.0.5)'
        required: false
        type: string
        default: 'dev'
      commit-sha:
        description: 'Git commit SHA'
        required: false
        type: string
        default: 'unknown'
      build-time:
        description: 'Build timestamp (RFC3339 format)'
        required: false
        type: string
        default: 'unknown'

jobs:
  build-linux:
    name: Build CLI (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 5 

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - run: go mod download

      - name: Build Linux binaries
        if: ${{ inputs.build-all-platforms }}
        run: |
          make build-linux \
            VERSION="${{ inputs.version }}" \
            COMMIT_SHA="${{ inputs.commit-sha }}" \
            BUILD_TIME="${{ inputs.build-time }}"

      - name: Verify build (Linux only)
        if: ${{ !inputs.build-all-platforms }}
        run: make build-cli

      - name: Upload Linux artifacts
        if: ${{ inputs.build-all-platforms }}
        uses: actions/upload-artifact@v4
        with:
          name: cli-linux
          path: dist/cli/linux/*
          retention-days: 1

  build-macos:
    name: Build CLI (macOS)
    runs-on: macos-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/Library/Caches/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - run: go mod download

      - name: Build macOS binaries
        if: ${{ inputs.build-all-platforms }}
        run: |
          make build-macos \
            VERSION="${{ inputs.version }}" \
            COMMIT_SHA="${{ inputs.commit-sha }}" \
            BUILD_TIME="${{ inputs.build-time }}"

      - name: Verify build (macOS only)
        if: ${{ !inputs.build-all-platforms }}
        run: make build-cli

      - name: Upload macOS artifacts
        if: ${{ inputs.build-all-platforms }}
        uses: actions/upload-artifact@v4
        with:
          name: cli-macos
          path: dist/cli/darwin/*
          retention-days: 1

  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - run: go mod download

      - name: Build WASM
        run: |
          make build-wasm \
            VERSION="${{ inputs.version }}" \
            COMMIT_SHA="${{ inputs.commit-sha }}" \
            BUILD_TIME="${{ inputs.build-time }}"

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm
          path: dist/wasm/main.wasm
          retention-days: 1
